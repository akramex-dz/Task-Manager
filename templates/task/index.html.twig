{% extends 'base.html.twig' %}

{% block body %}
    <div class="container mt-4">
        <h1 class="mb-4">Task List</h1>

        <div class="d-flex justify-content-end mb-1">
            <a href="{{ path('task_new') }}" class="btn btn-primary btn-md d-flex align-items-center gap-2 px-3" style="margin-bottom: 5px;">
                <i class="bi bi-plus-circle"></i> Create Task
            </a>
        </div>




        <!-- Search Form -->
        <form id="searchForm" method="get" class="mb-3">
            <div class="input-group">
                <input type="text" id="searchInput" name="q" class="form-control" placeholder="Search tasks..." onkeyup="performSearch()">
                <button class="btn btn-primary" type="submit" style="display: none;">Search</button>  <!-- Hide the submit button -->
            </div>
        </form>

        <!-- Task Table -->
        <table class="table table-striped" id="taskTable">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Image</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for task in tasks %}
                <tr>
                    <td>{{ task.id }}</td>
                    <td>{{ task.title }}</td>
                    <td>{{ task.status }}</td>
                    <td>{{ task.dueDate ? task.dueDate|date('Y-m-d H:i') : 'N/A' }}</td>
                    <td>
                        {% if task.image %}
                            <!-- View Image Button -->
                            <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewImageModal{{ task.id }}">View Image</button>
                            <br>
                            <img src="{{ asset('uploads/task_images/' ~ task.image) }}" alt="Task Image" class="img-thumbnail mt-2" width="100">
                        {% else %}
                            No Image
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ path('task_edit', { 'id': task.id }) }}" class="btn btn-warning btn-sm">Edit</a>
                        <a href="{{ path('task_duplicate', { 'id': task.id }) }}" class="btn btn-info btn-sm">Duplicate</a>
                        <form action="{{ path('task_delete', { 'id': task.id }) }}" method="post" class="d-inline">
                            <input type="hidden" name="_method" value="DELETE">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this task?')">Delete</button>
                        </form>
                    </td>
                </tr>

                <!-- Modal for Viewing Image -->
                <div class="modal fade" id="viewImageModal{{ task.id }}" tabindex="-1" aria-labelledby="viewImageModalLabel{{ task.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="viewImageModalLabel{{ task.id }}">View Image for Task #{{ task.id }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="{{ asset('uploads/task_images/' ~ task.image) }}" alt="Task Image" class="img-fluid">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <a href="{{ asset('uploads/task_images/' ~ task.image) }}" download class="btn btn-primary">Download Image</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // Perform AJAX search when the user types
        function performSearch() {
            const query = document.getElementById('searchInput').value;

            // Make an AJAX request to search
            fetch(`/task/api/task_search?q=${query}`, {
                method: 'GET',
            })
                .then(response => response.json())
                .then(data => {
                    // Populate the table with the search results
                    const tableBody = document.querySelector('#taskTable tbody');
                    tableBody.innerHTML = '';  // Clear existing rows

                    data.forEach(task => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>${task.id}</td>
                        <td>${task.title}</td>
                        <td>${task.status}</td>
                        <td>${task.dueDate}</td>
                        <td>${task.image ?
                                `<button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewImageModal${task.id}">View Image</button>
                                <br>
                                <img src="/uploads/task_images/${task.image}" alt="Task Image" class="img-thumbnail mt-2" width="100">`
                                : 'No Image'}
                        </td>
                        <td>
                            <a href="/task/edit/${task.id}" class="btn btn-warning btn-sm">Edit</a>
                            <a href="/task/duplicate/${task.id}" class="btn btn-info btn-sm">Duplicate</a>
                            <a href="/task/delete/${task.id}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">Delete</a>
                        </td>
                    `;
                        tableBody.appendChild(row);
                    });
                });
        }
    </script>
{% endblock %}
